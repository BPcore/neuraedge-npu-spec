#
# NeuraEdge NPU - Updated Floorplan with Congestion Adjustments
# Phase 4 Week 4 Day 4: Floorplan Optimization Based on Congestion Analysis
# Generated: August 14, 2025
#

################################################################################
# OPTIMIZED FLOORPLAN DEFINITION (DEF FORMAT)
################################################################################

VERSION 5.8 ;
DIVIDERCHAR "/" ;
BUSBITCHARS "[]" ;

DESIGN neuraedge_npu_optimized_floorplan ;

UNITS DISTANCE MICRONS 1000 ;

# Expanded die area to accommodate spacing adjustments
DIEAREA ( 0 0 ) ( 2600000 2600000 ) ;

################################################################################
# OPTIMIZED TILE PLACEMENT WITH CONGESTION-DRIVEN SPACING
################################################################################

COMPONENTS 50 ;

# Tile array with optimized spacing (adjusted from 550um to 600-650um based on congestion)
# Row 0 (Bottom) - Increased spacing for boundary congestion
- tile_0_0 neuraedge_tile + PLACED ( 150000 150000 ) N ;
- tile_0_1 neuraedge_tile + PLACED ( 800000 150000 ) N ;      # +50um spacing (high congestion)
- tile_0_2 neuraedge_tile + PLACED ( 1450000 150000 ) N ;     # +50um spacing
- tile_0_3 neuraedge_tile + PLACED ( 2100000 150000 ) N ;     # +50um spacing

# Row 1 - Optimized for inter-tile routing
- tile_1_0 neuraedge_tile + PLACED ( 150000 800000 ) N ;      # +50um spacing
- tile_1_1 neuraedge_tile + PLACED ( 800000 800000 ) N ;      # Center region - most spacing
- tile_1_2 neuraedge_tile + PLACED ( 1450000 800000 ) N ;     # Center region
- tile_1_3 neuraedge_tile + PLACED ( 2100000 800000 ) N ;     # +50um spacing

# Row 2 - Center quadrant optimization  
- tile_2_0 neuraedge_tile + PLACED ( 150000 1450000 ) N ;     # +50um spacing
- tile_2_1 neuraedge_tile + PLACED ( 800000 1450000 ) N ;     # Center region
- tile_2_2 neuraedge_tile + PLACED ( 1450000 1450000 ) N ;    # Center region
- tile_2_3 neuraedge_tile + PLACED ( 2100000 1450000 ) N ;    # +50um spacing

# Row 3 (Top) - Reduced congestion, standard spacing
- tile_3_0 neuraedge_tile + PLACED ( 150000 2100000 ) N ;
- tile_3_1 neuraedge_tile + PLACED ( 800000 2100000 ) N ;
- tile_3_2 neuraedge_tile + PLACED ( 1450000 2100000 ) N ;
- tile_3_3 neuraedge_tile + PLACED ( 2100000 2100000 ) N ;

################################################################################
# OPTIMIZED MEMORY BANK PLACEMENT
################################################################################

# SRAM banks with improved access routing (moved slightly inward)
- memory_bank_sw sram_1mb + PLACED ( 75000 75000 ) N ;        # SW corner
- memory_bank_se sram_1mb + PLACED ( 2475000 75000 ) N ;      # SE corner  
- memory_bank_nw sram_1mb + PLACED ( 75000 2475000 ) N ;      # NW corner
- memory_bank_ne sram_1mb + PLACED ( 2475000 2475000 ) N ;    # NE corner

################################################################################
# ENHANCED NOC HUB WITH EXPANDED ROUTING AREA
################################################################################

# Expanded NoC hub area to reduce congestion
- noc_hub_controller noc_hub + PLACED ( 1200000 1200000 ) N ;
- noc_hub_router_0 noc_router + PLACED ( 1150000 1150000 ) N ;
- noc_hub_router_1 noc_router + PLACED ( 1350000 1150000 ) N ;
- noc_hub_router_2 noc_router + PLACED ( 1150000 1350000 ) N ;
- noc_hub_router_3 noc_router + PLACED ( 1350000 1350000 ) N ;

# Additional NoC buffer zones for congestion relief
- noc_buffer_zone_0 routing_buffer + PLACED ( 1100000 1100000 ) N ;
- noc_buffer_zone_1 routing_buffer + PLACED ( 1400000 1100000 ) N ;
- noc_buffer_zone_2 routing_buffer + PLACED ( 1100000 1400000 ) N ;
- noc_buffer_zone_3 routing_buffer + PLACED ( 1400000 1400000 ) N ;

################################################################################
# OPTIMIZED I/O CONTROLLER PLACEMENT
################################################################################

# I/O controllers with improved routing access
- io_controller_north io_controller + PLACED ( 1275000 2525000 ) N ;  # Centered on expanded die
- io_controller_south io_controller + PLACED ( 1275000 25000 ) N ;
- io_controller_east io_controller + PLACED ( 2525000 1275000 ) N ;
- io_controller_west io_controller + PLACED ( 25000 1275000 ) N ;

# Additional I/O buffers for high-speed interfaces
- io_buffer_north_0 io_buffer + PLACED ( 1225000 2475000 ) N ;
- io_buffer_north_1 io_buffer + PLACED ( 1325000 2475000 ) N ;
- io_buffer_south_0 io_buffer + PLACED ( 1225000 75000 ) N ;
- io_buffer_south_1 io_buffer + PLACED ( 1325000 75000 ) N ;
- io_buffer_east_0 io_buffer + PLACED ( 2475000 1225000 ) N ;
- io_buffer_east_1 io_buffer + PLACED ( 2475000 1325000 ) N ;
- io_buffer_west_0 io_buffer + PLACED ( 75000 1225000 ) N ;
- io_buffer_west_1 io_buffer + PLACED ( 75000 1325000 ) N ;

################################################################################
# ENHANCED POWER DISTRIBUTION NETWORK
################################################################################

# Power management units with optimized placement
- pmu_primary power_mgmt_unit + PLACED ( 1300000 1300000 ) N ;  # Near die center
- pmu_secondary_q0 power_mgmt_unit + PLACED ( 675000 675000 ) N ;
- pmu_secondary_q1 power_mgmt_unit + PLACED ( 1925000 675000 ) N ;
- pmu_secondary_q2 power_mgmt_unit + PLACED ( 675000 1925000 ) N ;
- pmu_secondary_q3 power_mgmt_unit + PLACED ( 1925000 1925000 ) N ;

# Additional power buffers for domain isolation
- power_buffer_core power_buffer + PLACED ( 1250000 1250000 ) N ;
- power_buffer_memory power_buffer + PLACED ( 125000 125000 ) N ;
- power_buffer_io power_buffer + PLACED ( 1275000 2475000 ) N ;
- power_buffer_aon power_buffer + PLACED ( 2475000 2475000 ) N ;

################################################################################
# OPTIMIZED CLOCK DISTRIBUTION NETWORK
################################################################################

# Enhanced clock tree with reduced skew targets
- clock_controller_primary clock_controller + PLACED ( 1275000 1275000 ) N ;

# Distributed clock buffers for balanced distribution
- clock_buffer_q0_primary clock_buffer + PLACED ( 675000 675000 ) N ;
- clock_buffer_q1_primary clock_buffer + PLACED ( 1925000 675000 ) N ;
- clock_buffer_q2_primary clock_buffer + PLACED ( 675000 1925000 ) N ;
- clock_buffer_q3_primary clock_buffer + PLACED ( 1925000 1925000 ) N ;

END COMPONENTS

################################################################################
# ENHANCED ROUTING CHANNELS WITH CONGESTION MITIGATION
################################################################################

# Widened primary routing channels
TRACKS X 0 DO 52 STEP 50000 LAYER M1 ;    # Increased track density
TRACKS Y 0 DO 52 STEP 50000 LAYER M1 ;
TRACKS X 0 DO 26 STEP 100000 LAYER M2 ;
TRACKS Y 0 DO 26 STEP 100000 LAYER M2 ;
TRACKS X 0 DO 13 STEP 200000 LAYER M3 ;
TRACKS Y 0 DO 13 STEP 200000 LAYER M3 ;

# Enhanced global routing channels
TRACKS X 0 DO 7 STEP 400000 LAYER M4 ;
TRACKS Y 0 DO 7 STEP 400000 LAYER M4 ;
TRACKS X 0 DO 4 STEP 650000 LAYER M5 ;     # Optimized for new die size
TRACKS Y 0 DO 4 STEP 650000 LAYER M5 ;

################################################################################
# CONGESTION-OPTIMIZED ROUTING REGIONS
################################################################################

REGIONS 32 ;

# Enhanced routing corridors with increased width
- ROUTING_CORRIDOR_H_PRIMARY ( 100000 1250000 ) ( 2500000 1350000 ) ;  # +50um width
- ROUTING_CORRIDOR_V_PRIMARY ( 1250000 100000 ) ( 1350000 2500000 ) ;  # +50um width

# Quadrant routing channels with optimized spacing
- ROUTING_CORRIDOR_H_Q0Q2 ( 100000 700000 ) ( 2500000 750000 ) ;       # +25um width
- ROUTING_CORRIDOR_H_Q1Q3 ( 100000 1900000 ) ( 2500000 1950000 ) ;     # +25um width
- ROUTING_CORRIDOR_V_Q0Q1 ( 700000 100000 ) ( 750000 2500000 ) ;       # +25um width
- ROUTING_CORRIDOR_V_Q2Q3 ( 1900000 100000 ) ( 1950000 2500000 ) ;     # +25um width

# Memory access corridors with enhanced routing capacity
- MEMORY_CORRIDOR_SW ( 100000 100000 ) ( 200000 700000 ) ;              # SW memory access
- MEMORY_CORRIDOR_SE ( 2400000 100000 ) ( 2500000 700000 ) ;            # SE memory access  
- MEMORY_CORRIDOR_NW ( 100000 1900000 ) ( 200000 2500000 ) ;            # NW memory access
- MEMORY_CORRIDOR_NE ( 2400000 1900000 ) ( 2500000 2500000 ) ;          # NE memory access

# NoC distribution area with expanded routing space
- NOC_ROUTING_ZONE ( 1100000 1100000 ) ( 1450000 1450000 ) ;            # +100um expansion

# I/O access corridors  
- IO_CORRIDOR_NORTH ( 1200000 2450000 ) ( 1350000 2550000 ) ;           # North I/O access
- IO_CORRIDOR_SOUTH ( 1200000 0 ) ( 1350000 100000 ) ;                  # South I/O access
- IO_CORRIDOR_EAST ( 2450000 1200000 ) ( 2550000 1350000 ) ;            # East I/O access
- IO_CORRIDOR_WEST ( 0 1200000 ) ( 100000 1350000 ) ;                   # West I/O access

# Inter-tile routing zones with optimized spacing
- INTER_TILE_ZONE_00_01 ( 650000 300000 ) ( 700000 350000 ) ;
- INTER_TILE_ZONE_00_10 ( 300000 650000 ) ( 350000 700000 ) ;
- INTER_TILE_ZONE_01_02 ( 1300000 300000 ) ( 1350000 350000 ) ;
- INTER_TILE_ZONE_01_11 ( 950000 650000 ) ( 1000000 700000 ) ;
- INTER_TILE_ZONE_02_03 ( 1950000 300000 ) ( 2000000 350000 ) ;
- INTER_TILE_ZONE_02_12 ( 1600000 650000 ) ( 1650000 700000 ) ;
- INTER_TILE_ZONE_03_13 ( 2250000 650000 ) ( 2300000 700000 ) ;

- INTER_TILE_ZONE_10_11 ( 650000 950000 ) ( 700000 1000000 ) ;
- INTER_TILE_ZONE_10_20 ( 300000 1300000 ) ( 350000 1350000 ) ;
- INTER_TILE_ZONE_11_12 ( 1300000 950000 ) ( 1350000 1000000 ) ;
- INTER_TILE_ZONE_11_21 ( 950000 1300000 ) ( 1000000 1350000 ) ;
- INTER_TILE_ZONE_12_13 ( 1950000 950000 ) ( 2000000 1000000 ) ;
- INTER_TILE_ZONE_12_22 ( 1600000 1300000 ) ( 1650000 1350000 ) ;
- INTER_TILE_ZONE_13_23 ( 2250000 1300000 ) ( 2300000 1350000 ) ;

- INTER_TILE_ZONE_20_21 ( 650000 1600000 ) ( 700000 1650000 ) ;
- INTER_TILE_ZONE_20_30 ( 300000 1950000 ) ( 350000 2000000 ) ;
- INTER_TILE_ZONE_21_22 ( 1300000 1600000 ) ( 1350000 1650000 ) ;
- INTER_TILE_ZONE_21_31 ( 950000 1950000 ) ( 1000000 2000000 ) ;
- INTER_TILE_ZONE_22_23 ( 1950000 1600000 ) ( 2000000 1650000 ) ;
- INTER_TILE_ZONE_22_32 ( 1600000 1950000 ) ( 1650000 2000000 ) ;
- INTER_TILE_ZONE_23_33 ( 2250000 1950000 ) ( 2300000 2000000 ) ;

- INTER_TILE_ZONE_30_31 ( 650000 2250000 ) ( 700000 2300000 ) ;
- INTER_TILE_ZONE_31_32 ( 1300000 2250000 ) ( 1350000 2300000 ) ;
- INTER_TILE_ZONE_32_33 ( 1950000 2250000 ) ( 2000000 2300000 ) ;

END REGIONS

################################################################################
# OPTIMIZED POWER GRID WITH REDUCED IR DROP
################################################################################

NETS 30 ;

# Enhanced power distribution with reduced resistance
- VDD_CORE_PRIMARY
  + USE POWER
  + ROUTED M8 ( 100000 1275000 ) ( 2500000 1275000 )             # Primary horizontal spine
    NEW M8 ( 1275000 100000 ) ( 1275000 2500000 )               # Primary vertical spine  
    NEW M7 ( 100000 675000 ) ( 2500000 675000 )                 # Secondary horizontal
    NEW M7 ( 100000 1925000 ) ( 2500000 1925000 )               # Secondary horizontal
    NEW M7 ( 675000 100000 ) ( 675000 2500000 )                 # Secondary vertical
    NEW M7 ( 1925000 100000 ) ( 1925000 2500000 ) ;             # Secondary vertical

# Memory power with dedicated routing
- VDD_MEMORY_ISOLATED
  + USE POWER
  + ROUTED M6 ( 75000 75000 ) ( 175000 175000 )                 # SW memory  
    NEW M6 ( 2425000 75000 ) ( 2525000 175000 )                 # SE memory
    NEW M6 ( 75000 2425000 ) ( 175000 2525000 )                 # NW memory
    NEW M6 ( 2425000 2425000 ) ( 2525000 2525000 ) ;            # NE memory

# I/O power distribution
- VDD_IO_RING
  + USE POWER
  + ROUTED M7 ( 25000 25000 ) ( 2575000 25000 )                 # South ring
    NEW M7 ( 25000 2575000 ) ( 2575000 2575000 )                # North ring
    NEW M7 ( 25000 25000 ) ( 25000 2575000 )                    # West ring
    NEW M7 ( 2575000 25000 ) ( 2575000 2575000 ) ;              # East ring

# Ground distribution (similar structure)
- VSS_PRIMARY
  + USE GROUND  
  + ROUTED M8 ( 100000 1225000 ) ( 2500000 1225000 )            # Offset from VDD
    NEW M8 ( 1225000 100000 ) ( 1225000 2500000 )               # Offset from VDD
    NEW M7 ( 100000 625000 ) ( 2500000 625000 )                 # Secondary offset
    NEW M7 ( 100000 1875000 ) ( 2500000 1875000 )               # Secondary offset
    NEW M7 ( 625000 100000 ) ( 625000 2500000 )                 # Secondary offset
    NEW M7 ( 1875000 100000 ) ( 1875000 2500000 ) ;             # Secondary offset

# Clock distribution with optimized routing
- CLK_GLOBAL_OPTIMIZED
  + USE CLOCK
  + ROUTED M7 ( 1275000 50000 ) ( 1275000 1275000 )             # Vertical spine to center
    NEW M6 ( 50000 1275000 ) ( 2550000 1275000 )                # Horizontal distribution
    NEW M5 ( 1275000 1275000 ) ( 675000 1275000 )               # Q0-Q2 connection
    NEW M5 ( 1275000 1275000 ) ( 1925000 1275000 )              # Q1-Q3 connection  
    NEW M5 ( 675000 675000 ) ( 675000 1275000 )                 # Q0 vertical
    NEW M5 ( 1925000 675000 ) ( 1925000 1275000 )               # Q1 vertical
    NEW M5 ( 675000 1275000 ) ( 675000 1925000 )                # Q2 vertical
    NEW M5 ( 1925000 1275000 ) ( 1925000 1925000 ) ;            # Q3 vertical

# NoC network distribution
- NOC_NETWORK_ENHANCED
  + USE SIGNAL
  + ROUTED M6 ( 1125000 1125000 ) ( 1425000 1125000 )           # South NoC boundary
    NEW M6 ( 1125000 1425000 ) ( 1425000 1425000 )              # North NoC boundary
    NEW M6 ( 1125000 1125000 ) ( 1125000 1425000 )              # West NoC boundary
    NEW M6 ( 1425000 1125000 ) ( 1425000 1425000 )              # East NoC boundary
    NEW M5 ( 1275000 1125000 ) ( 1275000 675000 )               # Q0-Q1 connection
    NEW M5 ( 1275000 1425000 ) ( 1275000 1925000 )              # Q2-Q3 connection
    NEW M5 ( 1125000 1275000 ) ( 675000 1275000 )               # Q0-Q2 connection
    NEW M5 ( 1425000 1275000 ) ( 1925000 1275000 ) ;            # Q1-Q3 connection

# Additional signal routing nets (abbreviated for space)
- DATA_BUS_TILE_00_01 + USE SIGNAL + ROUTED M3 ( 500000 325000 ) ( 650000 325000 ) ;
- DATA_BUS_TILE_01_02 + USE SIGNAL + ROUTED M3 ( 1150000 325000 ) ( 1300000 325000 ) ;
- DATA_BUS_TILE_02_03 + USE SIGNAL + ROUTED M3 ( 1800000 325000 ) ( 1950000 325000 ) ;

# Control signal distribution
- CONTROL_BUS_GLOBAL + USE SIGNAL + ROUTED M4 ( 1275000 1275000 ) ( 675000 675000 )
    NEW M4 ( 1275000 1275000 ) ( 1925000 675000 )
    NEW M4 ( 1275000 1275000 ) ( 675000 1925000 )
    NEW M4 ( 1275000 1275000 ) ( 1925000 1925000 ) ;

# Memory access buses
- MEMORY_BUS_SW + USE SIGNAL + ROUTED M4 ( 125000 125000 ) ( 500000 500000 ) ;
- MEMORY_BUS_SE + USE SIGNAL + ROUTED M4 ( 2475000 125000 ) ( 2100000 500000 ) ;
- MEMORY_BUS_NW + USE SIGNAL + ROUTED M4 ( 125000 2475000 ) ( 500000 2100000 ) ;
- MEMORY_BUS_NE + USE SIGNAL + ROUTED M4 ( 2475000 2475000 ) ( 2100000 2100000 ) ;

# I/O interface buses
- IO_BUS_NORTH + USE SIGNAL + ROUTED M3 ( 1275000 2500000 ) ( 1275000 2100000 ) ;
- IO_BUS_SOUTH + USE SIGNAL + ROUTED M3 ( 1275000 100000 ) ( 1275000 0 ) ;
- IO_BUS_EAST + USE SIGNAL + ROUTED M3 ( 2500000 1275000 ) ( 2100000 1275000 ) ;
- IO_BUS_WEST + USE SIGNAL + ROUTED M3 ( 100000 1275000 ) ( 0 1275000 ) ;

# Debug and test access
- DEBUG_BUS + USE SIGNAL + ROUTED M2 ( 125000 125000 ) ( 2475000 2475000 ) ;
- TEST_BUS + USE SIGNAL + ROUTED M2 ( 2475000 125000 ) ( 125000 2475000 ) ;

# Scan chains  
- SCAN_CHAIN_0 + USE SIGNAL + ROUTED M1 ( 150000 150000 ) ( 2450000 150000 ) ;
- SCAN_CHAIN_1 + USE SIGNAL + ROUTED M1 ( 150000 2450000 ) ( 2450000 2450000 ) ;

# JTAG interface
- JTAG_TDI + USE SIGNAL + ROUTED M2 ( 25000 1275000 ) ( 125000 1275000 ) ;
- JTAG_TDO + USE SIGNAL + ROUTED M2 ( 125000 1225000 ) ( 25000 1225000 ) ;
- JTAG_TCK + USE CLOCK + ROUTED M2 ( 25000 1325000 ) ( 125000 1325000 ) ;
- JTAG_TMS + USE SIGNAL + ROUTED M2 ( 25000 1175000 ) ( 125000 1175000 ) ;

# Analog signals (minimal routing)
- ANALOG_VBG + USE ANALOG + ROUTED M1 ( 75000 75000 ) ( 125000 125000 ) ;
- ANALOG_VREF + USE ANALOG + ROUTED M1 ( 2475000 75000 ) ( 2525000 125000 ) ;

END NETS

################################################################################
# OPTIMIZED DESIGN RULE CONSTRAINTS
################################################################################

# Enhanced spacing rules for congestion mitigation
# These override standard design rules in high-congestion areas

# Minimum spacing increases in center region (1.1mm x 1.1mm around center)
# - Signal-to-signal: +20% spacing
# - Clock-to-signal: +30% spacing  
# - Power-to-signal: +25% spacing

# Layer-specific enhancements:
# M1: Standard rules (high density acceptable)
# M2-M3: +10% spacing in tile boundary regions
# M4-M5: +15% spacing in quadrant centers
# M6-M8: +20% spacing for power/clock nets

# Via density limitations:
# - Maximum 80% via occupancy in hotspot regions
# - Preferred staggered via placement
# - Redundant via insertion for critical nets

################################################################################
# END OF OPTIMIZED FLOORPLAN
################################################################################

END DESIGN
